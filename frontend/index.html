<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deli Shop - Fresh & Delicious</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://www.paypal.com/sdk/js?client-id=AYoZx-D_-UbqqLkxQ6Q0LfNID8oSbmVaAgke1URKD3pXKiRP9S5hG2eRcuW5wC1mFoB8pC_ExnKaG4CP&currency=USD"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Welcome to Deli Shop<span class="emoji">ü•™</span></h1>
      <p class="subtitle">Fresh ingredients, crafted with love</p>
    </div>

    <div id="loading" class="loading hidden">Loading delicious items...</div>
    
    <div id="products" class="products-grid"></div>
    
    <div id="paypal-container" class="paypal-container hidden">
      <h3>Complete Your Order</h3>
      <div id="selected-item" class="selected-item">
        <div class="selected-item-name"></div>
        <div class="selected-item-price"></div>
      </div>
      <div id="paypal-button-container"></div>
    </div>

    <div class="footer">
      <p>Made with <span class="heart">‚ù§Ô∏è</span> for food lovers</p>
      <p>Secure payments powered by PayPal</p>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="success-modal" class="modal-overlay hidden">
    <div class="success-modal">
      <!-- Confetti Animation -->
      <div class="confetti"></div>
      <div class="confetti"></div>
      <div class="confetti"></div>
      <div class="confetti"></div>
      <div class="confetti"></div>
      <div class="confetti"></div>
      <div class="confetti"></div>
      <div class="confetti"></div>
      <div class="confetti"></div>

      <div class="modal-icon">üéâ</div>
      <div class="modal-title" id="modal-dynamic-title">Transaction Completed!</div>
      <div class="modal-item-highlight">
        <div class="modal-item-emoji">ü•™</div>
        <div class="modal-item-text" id="modal-featured-item">Item Name</div>
      </div>
      <div class="modal-message" id="modal-dynamic-message">
        Thank you for your purchase! Your order has been successfully processed.
      </div>
      
      <div class="order-details">
        <div class="order-detail-row">
          <span class="order-detail-label">Order ID:</span>
          <span class="order-detail-value" id="modal-order-id">-</span>
        </div>
        <div class="order-detail-row">
          <span class="order-detail-label">Item:</span>
          <span class="order-detail-value" id="modal-item-name">-</span>
        </div>
        <div class="order-detail-row">
          <span class="order-detail-label">Amount:</span>
          <span class="order-detail-value" id="modal-amount">-</span>
        </div>
        <div class="order-detail-row">
          <span class="order-detail-label">Customer:</span>
          <span class="order-detail-value" id="modal-customer-name">-</span>
        </div>
        <div class="order-detail-row">
          <span class="order-detail-label">Transaction ID:</span>
          <span class="order-detail-value" id="modal-transaction-id">-</span>
        </div>
        <div class="order-detail-row">
          <span class="order-detail-label">Status:</span>
          <span class="order-detail-value" id="modal-status">-</span>
        </div>
      </div>

      <button class="modal-close-btn" onclick="closeSuccessModal()">
        Continue Shopping
      </button>
    </div>
  </div>

  <script>
    let selectedItemId = null;
    let selectedProduct = null;

    async function loadProducts() {
      try {
        showLoading(true);
        const res = await fetch('/api/products');
        const products = await res.json();
        const container = document.getElementById('products');
        
        container.innerHTML = '';
        
        products.forEach(product => {
          const productCard = document.createElement('div');
          productCard.className = 'product-card fade-in';
          productCard.innerHTML = `
            <div class="product-name">${product.name}</div>
            <div class="product-price">$${product.price.toFixed(2)}</div>
            <div class="product-description">${product.description}</div>
            <button class="select-btn" onclick="selectProduct('${product._id}', '${product.name}', ${product.price})">
              Select Item
            </button>
          `;
          container.appendChild(productCard);
        });
        
        showLoading(false);
      } catch (error) {
        showError('Failed to load products. Please refresh the page.');
        showLoading(false);
      }
    }

    function selectProduct(id, name, price) {
      selectedItemId = id;
      selectedProduct = { name, price };
      
      // Update UI to show selection
      document.querySelectorAll('.product-card').forEach(card => {
        card.classList.remove('selected');
      });
      event.target.closest('.product-card').classList.add('selected');
      
      // Show PayPal container
      const paypalContainer = document.getElementById('paypal-container');
      paypalContainer.classList.remove('hidden');
      
      // Update selected item display
      document.querySelector('.selected-item-name').textContent = name;
      document.querySelector('.selected-item-price').textContent = `$${price.toFixed(2)}`;
      
      // Clear and render PayPal button
      document.getElementById('paypal-button-container').innerHTML = '';
      renderPayPalButton();
      
      // Smooth scroll to PayPal section
      paypalContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function renderPayPalButton() {
      paypal.Buttons({
        style: {
          color: 'blue',
          shape: 'pill',
          label: 'pay',
          height: 50
        },
        createOrder: async () => {
          try {
            const res = await fetch('/api/create-order', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ itemId: selectedItemId })
            });
            const data = await res.json();
            return data.id;
          } catch (error) {
            showError('Failed to create order. Please try again.');
            throw error;
          }
        },
        onApprove: async (data) => {
          try {
            showLoading(true);
            const res = await fetch(`/api/capture-order/${data.orderID}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ itemId: selectedItemId })
            });
            const details = await res.json();
            showLoading(false);
            
            // Show success modal instead of alert
            showSuccessModal(details);
            
            // Reset selection after modal is closed
            setTimeout(() => {
              resetSelection();
            }, 1000);
          } catch (error) {
            showLoading(false);
            showError('Payment processing failed. Please contact support.');
          }
        },
        onError: err => {
          console.error('PayPal Error:', err);
          showError("‚ùå Payment failed. Please try again.");
        },
        onCancel: () => {
          showError("Payment cancelled. Feel free to try again!");
        }
      }).render('#paypal-button-container');
    }

    function showLoading(show) {
      const loading = document.getElementById('loading');
      if (show) {
        loading.classList.remove('hidden');
      } else {
        loading.classList.add('hidden');
      }
    }

    function showSuccess(message) {
      removeMessages();
      const successDiv = document.createElement('div');
      successDiv.className = 'success-message';
      successDiv.innerHTML = `<strong>${message}</strong>`;
      document.querySelector('.container').insertBefore(successDiv, document.getElementById('products'));
      
      setTimeout(() => {
        successDiv.remove();
      }, 5000);
    }

    function showError(message) {
      removeMessages();
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.innerHTML = `<strong>${message}</strong>`;
      document.querySelector('.container').insertBefore(errorDiv, document.getElementById('products'));
      
      setTimeout(() => {
        errorDiv.remove();
      }, 5000);
    }

    function removeMessages() {
      document.querySelectorAll('.success-message, .error-message').forEach(msg => msg.remove());
    }

    function resetSelection() {
      selectedItemId = null;
      selectedProduct = null;
      document.querySelectorAll('.product-card').forEach(card => {
        card.classList.remove('selected');
      });
      document.getElementById('paypal-container').classList.add('hidden');
      removeMessages();
    }

    // Success Modal Functions
    function showSuccessModal(orderDetails) {
      const itemName = orderDetails.item || 'N/A';
      const customerName = orderDetails.buyerName || 'Customer';
      
      // Update dynamic content to feature the item name
      document.getElementById('modal-dynamic-title').textContent = `${itemName} Order Complete!`;
      document.getElementById('modal-dynamic-message').textContent = 
        `Thank you ${customerName}! Your ${itemName} has been successfully ordered and paid for.`;
      
      // Populate modal with order details
      document.getElementById('modal-order-id').textContent = orderDetails.paypalOrderId || orderDetails._id || 'N/A';
      document.getElementById('modal-item-name').textContent = itemName;
      document.getElementById('modal-featured-item').textContent = itemName;
      document.getElementById('modal-amount').textContent = `$${orderDetails.amount || '0.00'}`;
      document.getElementById('modal-customer-name').textContent = customerName;
      document.getElementById('modal-transaction-id').textContent = orderDetails.transactionId || 'N/A';
      document.getElementById('modal-status').textContent = orderDetails.status || 'COMPLETED';
      
      // Show the modal
      document.getElementById('success-modal').classList.remove('hidden');
      
      // Prevent body scrolling
      document.body.style.overflow = 'hidden';
    }

    function closeSuccessModal() {
      document.getElementById('success-modal').classList.add('hidden');
      document.body.style.overflow = 'auto';
      resetSelection();
    }

    // Close modal when clicking overlay
    document.getElementById('success-modal').addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) {
        closeSuccessModal();
      }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeSuccessModal();
      }
    });

    // Initialize the application
    document.addEventListener('DOMContentLoaded', () => {
      loadProducts();
    });
  </script>
</body>
</html>
